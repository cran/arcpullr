---
title: "Spatial Queries"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme:
      version: 5
vignette: > 
  %\VignetteIndexEntry{Spatial Queries}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

---
title: "Spatial Queries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to arcpullr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---
To see more complete package documentation check out:
<a href="https://pfrater.github.io/arcpullr/">
https://pfrater.github.io/arcpullr/</a>
<hr>
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(arcpullr)
library(sf)
```

```{r, echo = FALSE}
#<img src='../man/figures/logo.png' width="160" height="180" style="border: none" align="right"/>
```


ArcGIS REST API's may be spatially queried using the get_layer_by\_\* family of 
functions. These functions require a spatial object of 
class \code{sf} (*i.e.* of the R package [sf:
Simple Features for R](https://r-spatial.github.io/sf/)) and a 
[Spatial Relationship](https://help.arcgis.com/en/webapi/wpf/apiref/ESRI.ArcGIS.Client~ESRI.ArcGIS.Client.Tasks.SpatialRelationship.html)
to be passed to the geometry and `sp_rel` arguments respectively.

The package contains five functions that can be used to perform
spatial queries:

<ul>

<li>

`get_layer_by_line`

<li>

`get_layer_by_point`

<li>

`get_layer_by_polygon`

<li>

`get_layer_by_multipoint`

<li>

`get_layer_by_envelope`

</u >

## URL's for examples 
<a class="btn btn-primary" data-bs-toggle="collapse"href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
Example Source Data
</a>
<div class="collapse" id="collapseExample">
  <div class="card card-body"> 
```{r}

#WDNR Server
server <- "https://dnrmaps.wi.gov/arcgis/rest/services/"
server2 <- "https://dnrmaps.wi.gov/arcgis2/rest/services/"

#River URL
layer <- "TS_AGOL_STAGING_SERVICES/EN_AGOL_STAGING_SurfaceWater_WTM/MapServer/2"
river_url <- paste0(server2,layer)

#Country URL 
layer <- "DW_Map_Dynamic/EN_Basic_Basemap_WTM_Ext_Dynamic_L16/MapServer/3"
county_url <- paste0(server,layer)

#Trout URL 
layer <- "FM_Trout/FM_TROUT_HAB_SITES_WTM_Ext/MapServer/0"
trout_url <- paste0(server,layer)

#Watershed URL
layer <- "WT_SWDV/WT_Inland_Water_Resources_WTM_Ext_v2/MapServer/5"
watershed_url <- paste0(server,layer)

#get layers for queries
brown_county <- wis_counties[wis_counties$county == "brown",]
mke_river <- get_spatial_layer(river_url, 
                               where = "RIVER_SYS_NAME = 'Milwaukee River'")

trout_hab_project<- 
  get_spatial_layer(
    trout_url,
    where = "WATERBODYNAMECOMBINED = 'Little Bois Brule'")

trout_hab_projects<- 
  get_spatial_layer(
    trout_url,
    where = "FISCALYEAR = 2018")

```
</div>
</div>
<br>

## get_layer_by_line
The `get_layer_by_line` function uses A LINSESTRING or MULTILINESTRING sf object 
to query an ArcGIS REST API. The below example uses a MULTILINESTRING sf 
object of the Milwaukee River to query the Wisconsin County polygon layer. 

```{r}
counties <- get_layer_by_line(url = county_url, geometry = mke_river)

ggplot2::ggplot() + 
  ggplot2::geom_sf(data = counties) +
  ggplot2::geom_sf(data = mke_river,color = "blue")

```

## get_layer_by_point

The `get_layer_by_line` function uses a POINT sf object to query 
an ArcGIS REST API. The below example shows how this can be used to return
which rivers intersect with a trout habitat project on the Little Bois Brule
river. 

```{r}

trout_streams <-
  get_layer_by_point(url = river_url, geometry = trout_hab_project)

ggplot2::ggplot() +
  ggplot2::geom_sf(data = trout_streams, color = "blue") +
  ggplot2::geom_sf(data = trout_hab_project,color = "red") 


```

## get_layer_by_multipoint

The `get_layer_by_multipoint` function uses a MULTIPOINT sf object to query 
an ArcGIS REST API. The below example shows how this can be used to determine 
which Wisconsin counties intersect with trout habitat projects completed in 2018
```{r}
trout_counties2018 <-
  get_layer_by_multipoint(url = county_url, geometry = trout_hab_projects)

ggplot2::ggplot() +
  ggplot2::geom_sf(data = wis_counties)+
  ggplot2::geom_sf(data = trout_counties2018,
                   fill = "gray75",color = "gray60") +
  ggplot2::geom_sf(data = trout_hab_projects,color = "red") 
```

## get_layer_by_polygon
The `get_layer_by_line` function uses a POLYGON sf object to query 
an ArcGIS REST API. The below examples shows how this can be used to find
what rivers intersect with Wisconsin's Brown County.

```{r}
brown_rivers <-get_layer_by_poly(river_url,brown_county)
ggplot2::ggplot()+
  ggplot2::geom_sf(data = brown_county) +
  ggplot2::geom_sf(data = brown_rivers,color = "blue",alpha = 0.25)
```

## get_layer_by_envelope
The `get_layer_by_envelope` function accepts any sf object to query an
ArcGIS REST API using the sf objects bounding box.  The below example
shows how this is used to query WI's Rivers ArcGIS REST API using a  sf POLYGON 
object of Wisconsin's Brown county. Note how the results compare
to when this same object is queried using the get_layer_by_polygon function. 
```{r}
brown_rivers <- get_layer_by_envelope(river_url,brown_county)
ggplot2::ggplot()+
  ggplot2::geom_sf(data = brown_county) +
  ggplot2::geom_sf(data = brown_rivers,color = "blue",alpha = 0.25)

```

## Combining Spatial and SQL Queries
Spatial queries can be combined with SQL statements to further refine queries.

```{r}
brown_rivers <- get_layer_by_poly(river_url,
                                  brown_county,
                                  where = "STREAM_ORDER > 3")
ggplot2::ggplot()+
  ggplot2::geom_sf(data = brown_county) +
  ggplot2::geom_sf(data = brown_rivers,color = "blue",alpha = 0.25)
```

## Spatial Relationship

The `sp_rel` argument can be used to define the spatial relationship
between the two feature classes involved within a spatial query. The
default spatial relationships for the `get_layer_by_poly` function is 
"esriSpatialRelContains". All other functions default to 
"esriSpatialRelIntersects". 

```{r}
brown_rivers <-get_layer_by_poly(river_url,brown_county)
ggplot2::ggplot()+
  ggplot2::geom_sf(data = brown_county) +
  ggplot2::geom_sf(data = brown_rivers,color = "blue",alpha = 0.25)

```

Using "esriSpatialRelCrosses" returns different records compared to the 
above example. 
```{r}
brown_rivers <-get_layer_by_poly(river_url,brown_county,sp_rel = "esriSpatialRelCrosses")
ggplot2::ggplot()+
  ggplot2::geom_sf(data = brown_county) +
  ggplot2::geom_sf(data = brown_rivers,color = "blue",alpha = 0.25)
```
<br>

### Lookup Tables
The `sp_rel_lookup` data.frame explains the various types of
spatial relationships available through ArcGIS REST APIs.

```{r, echo = FALSE}
sp_rel_lookup %>%
  DT::datatable()
```
<br>
The `sp_rel_valid` data.frame shows which spatial relationships are
valid with different geometry types being queried and used to do spatial
queries.

```{r, echo = FALSE}
sp_rel_valid %>%
  DT::datatable()

```

### The valid_sp_rel Function 
The `valid_sp_rel`  function can be used to to see which spatial relation
types are applicable to different geometries.

```{r, echo = TRUE}

valid_sp_rel("line","line")

```
